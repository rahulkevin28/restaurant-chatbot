<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spice Villa Chatbot ğŸ½ï¸</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ config['VERSION'] }}">
<style>
body {
    margin: 0; padding: 0; height: 100vh; background: #f0f2f5;
    display: flex; align-items: center; justify-content: center;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
}

.chat-container {
    display: flex; flex-direction: column; width: 420px; height: 90vh;
    background: #fff; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    overflow: hidden; position: relative; z-index: 5;
}

.chat-header {
    display: flex; align-items: center; background: #075e54; color: white; padding: 15px;
}
.chat-header img { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; }
.chat-header h2 { margin: 0; font-size: 20px; }
.chat-header p { margin: 0; font-size: 13px; color: #b2dfdb; }

.menu-panel { background: #f9f9fb; padding: 10px 15px; border-bottom: 1px solid #ddd; }
.menu-panel h3 { color: #075e54; font-size: 16px; margin-bottom: 5px; }
.menu-items { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
.menu-item, .dashboard-btn, .quick-actions button {
    background: #25d366; color: white; border: none; border-radius: 25px;
    padding: 8px 12px; font-size: 14px; cursor: pointer; transition: 0.2s;
}
.menu-item:hover, .dashboard-btn:hover, .quick-actions button:hover { background: #128c7e; }
.dashboard-btn { margin-top: 5px; }

.chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f5f5f5; }
.bubble { margin: 8px 0; padding: 12px 15px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; }
.bot-msg { background: #e4f7e9; align-self: flex-start; }
.user-msg { background: #d1e7ff; align-self: flex-end; text-align: right; }

.chat-input { display: flex; align-items: center; border-top: 1px solid #ddd; background: white; padding: 10px 15px; }
.chat-input input { flex: 1; border: 1px solid #ccc; border-radius: 25px; padding: 10px 15px; font-size: 15px; outline: none; }
.chat-input button { margin-left: 10px; background: #25d366; color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 20px; cursor: pointer; }
.chat-input button:hover { background: #128c7e; }

.dashboard-panel {
    position: absolute; top: 0; right: -100%;
    width: 100%; height: 100%; background: #eef5f4; padding: 15px;
    border-top-left-radius: 20px; border-bottom-left-radius: 20px;
    transition: right 0.3s ease; box-sizing: border-box; overflow-y: auto; z-index: 15;
}
.dashboard-panel.active { right: 0; }
.dashboard-panel h3 { color: #075e54; margin-top: 0; }

.overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.15);
    opacity: 0; visibility: hidden; transition: opacity 0.3s ease; z-index: 10;
}
.overlay.active { opacity: 1; visibility: visible; }

.chat-box::-webkit-scrollbar { width: 6px; }
.chat-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.25); border-radius: 4px; }

@media (max-height: 700px) { .chat-container { height: 95vh; } }
.quick-actions { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
</style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo">
        <div>
            <h2>Spice Villa ğŸ½ï¸</h2>
            <p>Your Virtual Restaurant Assistant</p>
        </div>
    </div>

    <div class="menu-panel">
        <h3>Menu ğŸ´</h3>
        <div class="menu-items">
            <button class="menu-item">Pizza ğŸ•</button>
            <button class="menu-item">Burger ğŸ”</button>
            <button class="menu-item">Pasta ğŸ</button>
            <button class="menu-item">Coffee â˜•</button>
        </div>
        <div class="quick-actions">
            <button id="show-orders">ğŸ›’ My Orders</button>
            <button id="show-reservations">ğŸ½ï¸ My Reservations</button>
            <button id="clear-orders">ğŸ—‘ï¸ Clear Orders</button>
            <button id="clear-reservations">ğŸ—‘ï¸ Clear Reservations</button>
            {% if is_admin %}
            <button class="dashboard-btn" id="toggle-dashboard">ğŸ“Š Dashboard</button>
            {% endif %}
        </div>
    </div>

    <div class="chat-box" id="chat-box">
        <div class="bot-msg bubble">
            ğŸ‘‹ Hello! Welcome to <b>Spice Villa</b>.<br>
            You can order food, ask for recommendations, or reserve a table.<br>
            Try: â€œIâ€™d like to order pizzaâ€ or â€œBook a table for 2 at 8 PMâ€.
        </div>
    </div>

    <div class="dashboard-panel" id="dashboard-panel">
        <h3>ğŸ“Š System Dashboard</h3>
        <p><b>ğŸ§  Model Accuracy:</b> <span id="accuracy">Loading...</span></p>
        <p><b>ğŸ’¾ Database:</b> <span id="storage">Loading...</span></p>
        <p><b>ğŸ“ˆ Orders:</b> <span id="orders">Loading...</span></p>
        <p><b>ğŸ½ï¸ Reservations:</b> <span id="reservations">Loading...</span></p>
        <p><b>ğŸ“ Feedback:</b> <span id="feedback">Loading...</span></p>
    </div>

    <div class="chat-input">
        <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
        <button id="send-btn">â¤</button>
    </div>
</div>

<div class="overlay" id="overlay"></div>

<script>
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const dashboardPanel = document.getElementById("dashboard-panel");
const toggleDashboardBtn = document.getElementById("toggle-dashboard");
const showOrdersBtn = document.getElementById("show-orders");
const showReservationsBtn = document.getElementById("show-reservations");
const clearOrdersBtn = document.getElementById("clear-orders");
const clearReservationsBtn = document.getElementById("clear-reservations");
const overlay = document.getElementById("overlay");

function escapeHTML(text) { const div = document.createElement("div"); div.textContent = text; return div.innerHTML; }
function appendMessage(sender, message) {
    const msgDiv = document.createElement("div");
    msgDiv.className = sender === "user" ? "user-msg bubble" : "bot-msg bubble";
    msgDiv.innerHTML = escapeHTML(message).replace(/\n/g, "<br>");
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function sendMessage(customMsg) {
    const msg = customMsg || input.value.trim();
    if (!msg) return;
    appendMessage("user", msg);
    input.value = "";
    const typing = document.createElement("div");
    typing.className = "bot-msg bubble";
    typing.innerHTML = "Typing...";
    chatBox.appendChild(typing);
    fetch("/get", { method: "POST", headers: {"Content-Type": "application/x-www-form-urlencoded"}, body: "msg=" + encodeURIComponent(msg) })
    .then(res => res.json())
    .then(data => { 
        chatBox.removeChild(typing); 
        appendMessage("bot", data.response); 
    })
    .catch(() => { chatBox.removeChild(typing); appendMessage("bot", "âš ï¸ Server error. Try again."); });
}

sendBtn.addEventListener("click", () => sendMessage());
input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

document.querySelectorAll(".menu-item").forEach(btn => {
    btn.addEventListener("click", () => sendMessage("I want " + btn.textContent));
});

toggleDashboardBtn?.addEventListener("click", () => {
    if (dashboardPanel.classList.contains("active")) {
        dashboardPanel.classList.remove("active");
        overlay.classList.remove("active");
        document.body.style.overflow = "auto";
        return;
    }
    fetch("/dashboard").then(res => res.json()).then(data => {
        document.getElementById("accuracy").textContent = data.model_accuracy ? data.model_accuracy + "%" : "N/A";
        document.getElementById("storage").textContent = data.data_storage || "N/A";
        document.getElementById("orders").textContent = data.total_orders ?? 0;
        document.getElementById("reservations").textContent = data.total_reservations ?? 0;
        document.getElementById("feedback").textContent = data.total_feedback ?? 0;
        dashboardPanel.classList.add("active");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
    }).catch(() => {
        dashboardPanel.classList.add("active"); overlay.classList.add("active");
        document.body.style.overflow = "hidden";
    });
});

overlay.addEventListener("click", () => {
    dashboardPanel.classList.remove("active");
    overlay.classList.remove("active");
    document.body.style.overflow = "auto";
});

showOrdersBtn.addEventListener("click", () => sendMessage("orders"));
showReservationsBtn.addEventListener("click", () => sendMessage("reservations"));

clearOrdersBtn.addEventListener("click", () => {
    if (!confirm("Clear all orders?")) return;
    fetch("/clear_orders", { method: "POST" })
        .then(res => res.json())
        .then(data => appendMessage("bot", data.response))
        .catch(() => appendMessage("bot", "âš ï¸ Error clearing orders."));
});

clearReservationsBtn.addEventListener("click", () => {
    if (!confirm("Clear all reservations?")) return;
    fetch("/clear_reservations", { method: "POST" })
        .then(res => res.json())
        .then(data => appendMessage("bot", data.response))
        .catch(() => appendMessage("bot", "âš ï¸ Error clearing reservations."));
});
</script>
</body>
</html>
